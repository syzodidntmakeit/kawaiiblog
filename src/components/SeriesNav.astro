---
import type { CollectionEntry } from 'astro:content';

interface Props {
  currentPost: CollectionEntry<'posts'>;
  allPosts: CollectionEntry<'posts'>[];
}

const { currentPost, allPosts } = Astro.props;
const series = currentPost.data.series;

// Only show if post is part of a series
if (!series) {
  return null;
}

// Get all posts in the same series
const seriesPosts = allPosts
  .filter(post => post.data.series?.name === series.name)
  .sort((a, b) => (a.data.series?.order || 0) - (b.data.series?.order || 0));

// Find current post index
const currentIndex = seriesPosts.findIndex(p => p.slug === currentPost.slug);
const prevPost = currentIndex > 0 ? seriesPosts[currentIndex - 1] : null;
const nextPost = currentIndex < seriesPosts.length - 1 ? seriesPosts[currentIndex + 1] : null;

// Calculate progress
const progress = ((currentIndex + 1) / seriesPosts.length) * 100;
---

{series && (
  <aside class="series-nav">
    <div class="series-header">
      <span class="series-icon">üìö</span>
      <div class="series-info">
        <h3>Part of a Series</h3>
        <p class="series-name">{series.name}</p>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" style={`width: ${progress}%`}></div>
    </div>
    <p class="progress-text">Part {currentIndex + 1} of {seriesPosts.length}</p>

    <div class="series-nav-buttons">
      {prevPost ? (
        <a href={`/posts/${prevPost.slug}`} class="nav-btn prev">
          <span class="arrow">‚Üê</span>
          <span class="label">Previous</span>
        </a>
      ) : (
        <div class="nav-btn disabled"></div>
      )}

      {nextPost ? (
        <a href={`/posts/${nextPost.slug}`} class="nav-btn next">
          <span class="label">Next</span>
          <span class="arrow">‚Üí</span>
        </a>
      ) : (
        <div class="nav-btn disabled"></div>
      )}
    </div>

    <details class="series-list">
      <summary>View All Parts ({seriesPosts.length})</summary>
      <ol>
        {seriesPosts.map((post, idx) => (
          <li class={post.slug === currentPost.slug ? 'current' : ''}>
            {post.slug === currentPost.slug ? (
              <span class="current-marker">‚Üí {post.data.title}</span>
            ) : (
              <a href={`/posts/${post.slug}`}>{post.data.title}</a>
            )}
          </li>
        ))}
      </ol>
    </details>
  </aside>
)}

<style>
  .series-nav {
    background: var(--card);
    border: 1px solid rgba(255, 192, 203, 0.3);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
  }

  .series-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }

  .series-icon {
    font-size: 2rem;
  }

  .series-info h3 {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--muted);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .series-name {
    font-size: 1.1rem;
    font-weight: 900;
    color: var(--pink);
    margin: 0;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 192, 203, 0.1);
    border-radius: 999px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--pink), var(--blue));
    transition: width 0.3s ease;
  }

  .progress-text {
    font-size: 0.85rem;
    color: var(--muted);
    text-align: center;
    margin-bottom: var(--spacing-md);
  }

  .series-nav-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }

  .nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(255, 192, 203, 0.1);
    border: 1px solid rgba(255, 192, 203, 0.3);
    border-radius: var(--radius-sm);
    color: var(--text);
    text-decoration: none;
    font-weight: 700;
    transition: var(--transition);
  }

  .nav-btn:not(.disabled):hover {
    background: rgba(255, 192, 203, 0.2);
    border-color: var(--pink);
    transform: translateY(-2px);
  }

  .nav-btn.disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .nav-btn .arrow {
    font-size: 1.2rem;
  }

  .series-list {
    border-top: 1px solid rgba(255, 192, 203, 0.2);
    padding-top: var(--spacing-md);
  }

  .series-list summary {
    cursor: pointer;
    font-weight: 700;
    color: var(--pink);
    user-select: none;
    margin-bottom: var(--spacing-sm);
  }

  .series-list summary:hover {
    text-decoration: underline;
  }

  .series-list ol {
    padding-left: 1.5rem;
    line-height: 1.8;
  }

  .series-list li {
    margin-bottom: 0.5rem;
  }

  .series-list li.current {
    font-weight: 700;
  }

  .current-marker {
    color: var(--pink);
  }

  .series-list a {
    color: var(--text);
    text-decoration: none;
  }

  .series-list a:hover {
    color: var(--pink);
    text-decoration: underline;
  }
</style>
