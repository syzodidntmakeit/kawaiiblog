---
import PostCard from "./PostCard.astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  currentPost: CollectionEntry<"posts">;
  allPosts: CollectionEntry<"posts">[];
}

const { currentPost, allPosts } = Astro.props;

// Calculate related posts based on category only, fallback to recent
function getRelatedPosts(
  current: CollectionEntry<"posts">,
  all: CollectionEntry<"posts">[],
  limit = 3,
) {
  // 1. Get posts in the same category (excluding current)
  const sameCategoryPosts = all
    .filter(
      (post) =>
        post.slug !== current.slug &&
        post.data.category === current.data.category,
    )
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  // 2. If we have enough, return them
  if (sameCategoryPosts.length >= limit) {
    return sameCategoryPosts.slice(0, limit);
  }

  // 3. If not, fill with recent posts
  const existingSlugs = new Set([
    current.slug,
    ...sameCategoryPosts.map((p) => p.slug),
  ]);

  const recentPosts = all
    .filter((post) => !existingSlugs.has(post.slug))
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    .slice(0, limit - sameCategoryPosts.length);

  return [...sameCategoryPosts, ...recentPosts];
}

const relatedPosts = getRelatedPosts(currentPost, allPosts);
---

{
  relatedPosts.length > 0 && (
    <section class="related-posts">
      <h2>You Might Also Like</h2>
      <div class="related-grid">
        {relatedPosts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    </section>
  )
}

<style>
  .related-posts {
    max-width: 1200px;
    margin: var(--spacing-xl) auto;
    padding: var(--spacing-xl) 0;
    border-top: 2px solid rgba(255, 192, 203, 0.2);
  }

  h2 {
    font-size: 2rem;
    font-weight: 900;
    margin-bottom: var(--spacing-lg);
    text-align: center;
    background: linear-gradient(120deg, var(--pink), var(--blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .related-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }

  @media (min-width: 768px) {
    .related-grid {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
  }
</style>
