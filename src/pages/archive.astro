---
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import SearchBar from '../components/SearchBar.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
})).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const categories = ['all', ...new Set(posts.map(p => p.data.category))];
---

<BaseLayout title="Archive" description="Browse all blog posts.">
  <div class="archive-header">
    <h1>Archive</h1>
    <SearchBar />
    
    <div class="filters">
      {categories.map(cat => (
        <button 
          class={`filter-btn ${cat === 'all' ? 'active' : ''}`}
          data-category={cat}
        >
          {cat}
        </button>
      ))}
    </div>
  </div>

  <div class="posts-grid" id="posts-grid">
    {posts.map(post => (
      <div 
        class="post-wrapper"
        data-slug={post.slug}
        data-category={post.data.category}
      >
        <PostCard post={post} />
      </div>
    ))}
  </div>
  
  <div id="no-results" class="hidden">
    <p>No posts found matching your search.</p>
  </div>
</BaseLayout>

<script>
  const postsGrid = document.getElementById('posts-grid');
  const postWrappers = document.querySelectorAll('.post-wrapper');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const noResults = document.getElementById('no-results');
  
  let currentCategory = 'all';
  let currentSearchIds: Set<string> | null = null;

  // Filter Logic
  function filterPosts() {
    let visibleCount = 0;
    
    postWrappers.forEach(wrapper => {
      const el = wrapper as HTMLElement;
      const category = el.dataset.category;
      const slug = el.dataset.slug;
      
      const matchesCategory = currentCategory === 'all' || category === currentCategory;
      const matchesSearch = currentSearchIds === null || (slug && currentSearchIds.has(slug));
      
      if (matchesCategory && matchesSearch) {
        el.style.display = 'block';
        visibleCount++;
      } else {
        el.style.display = 'none';
      }
    });
    
    if (noResults) {
      noResults.classList.toggle('hidden', visibleCount > 0);
    }
  }

  // Category Click Handler
  filterBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      
      // Update active state
      filterBtns.forEach(b => b.classList.remove('active'));
      target.classList.add('active');
      
      currentCategory = target.dataset.category || 'all';
      filterPosts();
    });
  });

  // Search Handler
  document.addEventListener('search-query', ((e: CustomEvent) => {
    const { query, results } = e.detail;
    
    if (!query) {
      currentSearchIds = null;
    } else {
      currentSearchIds = new Set(results.map((r: any) => r.item.slug));
    }
    
    filterPosts();
  }) as EventListener);
</script>

<style>
  .archive-header {
    margin-bottom: var(--spacing-xl);
    text-align: center;
  }

  h1 {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-lg);
  }

  .filters {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: var(--spacing-md);
    flex-wrap: wrap;
  }

  .filter-btn {
    background: transparent;
    border: 1px solid rgba(255, 192, 203, 0.2);
    color: var(--muted);
    padding: 0.5rem 1rem;
    border-radius: 999px;
    cursor: pointer;
    font-family: var(--font-primary);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8rem;
    transition: var(--transition);
  }

  .filter-btn:hover, .filter-btn.active {
    background: var(--pink);
    color: var(--bg);
    border-color: var(--pink);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to single column for mobile */
    gap: var(--spacing-xl);
    min-height: 50vh;
  }

  @media (min-width: 768px) {
    .posts-grid {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
  }
  
  #no-results {
    text-align: center;
    color: var(--muted);
    font-size: 1.2rem;
    margin-top: var(--spacing-xl);
  }
  
  .hidden {
    display: none;
  }
</style>
